from typing import Union

from pyspark.sql.types import StructType, StructField, StringType, ArrayType, DateType, BooleanType, IntegerType, \
    DataType


# noinspection PyPep8Naming
class {{resource.Name}}:
    @staticmethod
    def get_schema(recursion_depth: int = 0) -> Union[StructType, DataType]:
        """
{%  if resource.Description %}
        {{ resource.Description | wordwrap(78) | replace('\n', '\n        ') }}


    {% for property in properties%}
        {{ property.Name }}: {{ property.Description | wordwrap(78) | replace("\n", "\n            ") | replace("\r", "\n            ")}}

    {%  endfor %}
{%  endif %}
        """
{% for property in properties %}
    {% if property.UnderlyingDataType and property.UnderlyingDataType not in ["string","boolean","date","number"] %}
        {%  if property.UnderlyingDataType != resource.Name and property.IsUniqueUnderlyingDataType %}
            {% if property.IsResourceType %}
        from spark_fhir_schemas.r4.resources.{{property.UnderlyingDataType.lower()}} import {{property.UnderlyingDataType}}
            {% elif property.IsSimpleType %}
        from spark_fhir_schemas.r4.simple_types.{{property.UnderlyingDataType.lower()}} import {{property.UnderlyingDataType}}
            {% elif property.IsComplexType %}
        from spark_fhir_schemas.r4.complex_types.{{property.UnderlyingDataType.lower()}} import {{property.UnderlyingDataType}}
            {% else %}
        Not mapped: {{ property.UnderlyingDataType }}
            {% endif %}
        {% endif %}
    {% endif %}
{% endfor %}
{% if not properties %}
{#    if it is a simple property #}
    {% if resource.Type == "string" %}
        return StringType()
    {% elif resource.Type == "boolean" %}
        return BooleanType()
    {% elif resource.Type == "date" %}
        return DateType()
    {% elif resource.Type == "number" %}
        return IntegerType()
    {%  elif not resource.Type %}
        return StringType()
    {%  else %}
        Error: No mapping for {{ resource.Type }}
    {% endif %}
{%  else %}
        if recursion_depth > 3:
{#            print("reached recursion_depth for {{resource.Name}}")#}
            return StructType([])
        schema = StructType(
            [
                StructField("resourceType", StringType(), True),
    {% for property in properties%}
                # {{ property.Description | wordwrap(78) | replace("\n", "\n                # ") | replace("\r", "\n                # ")}}
        {% if property.Type == "array" %}
            {% if property.UnderlyingDataType and property.UnderlyingDataType not in ["string","boolean","date","number"] %}
                StructField("{{property.Name}}",ArrayType({{property.UnderlyingDataType}}.get_schema(recursion_depth+1)), True),
            {%  elif property.UnderlyingDataType == "string" %}
                StructField("{{property.Name}}",ArrayType(StringType()), True),
            {% elif property.Type == "boolean" or property.UnderlyingDataType == "boolean" %}
                StructField("{{property.Name}}",ArrayType(BooleanType()), True),
            {% elif property.Type == "date" or property.UnderlyingDataType == "date" %}
                StructField("{{property.Name}}",ArrayType(DateType()), True),
            {% elif property.Type == "number" or property.UnderlyingDataType == "number" %}
                StructField("{{property.Name}}",ArrayType(IntegerType()), True),
            {% endif %}
        {% elif not property.Type and not property.UnderlyingDataType %}
                StructField("{{property.Name}}", StringType(), True),
        {% elif property.Type == "string" or property.UnderlyingDataType == "string" %}
                StructField("{{property.Name}}", StringType(), True),
        {% elif property.Type == "boolean" or property.UnderlyingDataType == "boolean" %}
                StructField("{{property.Name}}", BooleanType(), True),
        {% elif property.Type == "date" or property.UnderlyingDataType == "date" %}
                StructField("{{property.Name}}", DateType(), True),
        {% elif property.Type == "number" or property.UnderlyingDataType == "number" %}
                StructField("{{property.Name}}", IntegerType(), True),
        {% else %}
                StructField("{{property.Name}}", {{property.UnderlyingDataType}}.get_schema(recursion_depth+1), True),
        {% endif%}
    {% endfor%}
            ]
        )
        return schema
{%  endif %}
